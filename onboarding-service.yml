spring:
  application:
    name: onboarding-service
  datasource:
    url: ${DATABASE_URL}
    username: ${DATABASE_USERNAME}
    password: ${DATABASE_PASSWORD}
  liquibase:
    change-log: db/changelog/changelog.yaml
    enabled: true
  jpa:
    hibernate:
      ddl-auto: none
    open-in-view: false


logging:
  level:
    liquibase: DEBUG

service:
  accounting:
    url: ${ACCOUNTING_URL}
  security:
    url: ${SECURITY_URL}


management:
  endpoints:
    web:
      exposure:
        include: mapping,bus-refresh,bus-env,circuitbreakerevents,retry,env,configprops
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true

resilience4j:
  circuitbreaker:
    circuit-breaker-aspect-order: 1
    configs:
      default:
        ignore-exceptions:
          - by.javaguru.jdmik7.onboardingservice.usecases.services.exeptions.RemoteServiceException
        failure-rate-threshold: 50 # 50% упавших из числа запросов. И далее врубаем fallback метод Close -> Open
        sliding-window-size: 2 # кол-во запрос для анализа
        sliding-window-type: COUNT_BASED # Кол-во запросов для анализа, можно поменять на время TIME_BASED
        minimum-number-of-calls: 1 # через сколько запросов начинать анализ
        automatic-transition-from-open-to-half-open-enabled: true # авто переход в open-to-half, чтобы попробовать запрос снова
        wait-duration-in-open-state:
          seconds: 4 # В это время по всем запросам возвращаем результат fallback метода. Ждём, давай ошибки исправится
        permitted-number-of-calls-in-half-open-state: 2 # Мы можем сделать две попытки проверить, ожил ли сервис
        register-health-indicator: true
    instances:
      security-service:
        base-config: default
      accounting-service:
        base-config: default
  retry:
    retry-aspect-order: 2
    configs:
      default:
        ignore-exceptions:
          - by.javaguru.jdmik7.onboardingservice.usecases.services.exeptions.RemoteServiceException
        max-attempts: 4
        wait-duration:
          seconds: 5
    instances:
      security-service:
        base-config: default
      accounting-service:
        base-config: default    

    


